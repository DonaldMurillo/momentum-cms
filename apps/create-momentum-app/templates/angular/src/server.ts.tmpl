import 'dotenv/config';

import {
	AngularNodeAppEngine,
	createNodeRequestHandler,
	isMainModule,
	writeResponseToNodeResponse,
} from '@angular/ssr/node';
import express from 'express';
import { dirname, resolve } from 'node:path';
import { fileURLToPath } from 'node:url';
import { createMomentumServer } from '@momentum-cms/server-express';
import { provideMomentumAPI } from '@momentum-cms/admin';
import momentumConfig, { authPlugin } from './momentum.config';

const serverDistFolder = dirname(fileURLToPath(import.meta.url));
const browserDistFolder = resolve(serverDistFolder, '../browser');

const angularApp = new AngularNodeAppEngine();

/**
 * Create the Momentum CMS server.
 * Handles: initialization, plugins, DB schema, seeding,
 * health endpoint, session resolver, and CMS API endpoints.
 */
const server = await createMomentumServer({
	config: momentumConfig,
	authPlugin,
	health: true,
	openapi: true,
	providerFactory: (api, ctx) =>
		provideMomentumAPI(api as Parameters<typeof provideMomentumAPI>[0], ctx),
});

/**
 * Serve static files from /browser.
 */
server.app.use(
	express.static(browserDistFolder, {
		maxAge: '1y',
		index: false,
		redirect: false,
	}),
);

/**
 * Handle all other requests by rendering the Angular application.
 */
server.app.use('/**', (req, res, next) => {
	const user = (req as Record<string, unknown>).user as
		| { id: string; email: string; role: string }
		| undefined;

	angularApp
		.handle(req, { providers: server.getSsrProviders(user) })
		.then((response) => (response ? writeResponseToNodeResponse(response, res) : next()))
		.catch(next);
});

/**
 * Start the server if this module is the main entry point.
 */
if (isMainModule(import.meta.url)) {
	const port = process.env['PORT'] || {{defaultPort}};
	server.app.listen(port, () => {
		console.warn(`Momentum CMS running at http://localhost:${port}`);
		console.warn(`Admin panel: http://localhost:${port}/admin`);
	});
}

/**
 * Request handler used by the Angular CLI dev server.
 */
export const reqHandler = createNodeRequestHandler(server.app);
